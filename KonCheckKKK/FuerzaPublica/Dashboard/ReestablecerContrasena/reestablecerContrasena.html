<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reestablecer Contrase√±a - KonCheck</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body,
    html {
      height: 100%;
      width: 100%;
      background: #f5f5f5;
    }

    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
      position: relative;
    }

    .left-panel {
      flex: 1;
      background-image: url("../../../Assets/FONDOINGRESAR-FP.png");
      background-position: center center;
      background-repeat: no-repeat;
      background-size: cover;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      padding: 60px;
      color: white;
      position: relative;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      position: absolute;
      top: 20px;
      left: 20px;
      margin: 0;
      cursor: pointer;
    }

    .brand .logo img {
      width: 60px;
      height: 60px;
    }

    .brand h1 {
      font-weight: 700;
      font-size: 1.6rem;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
    }

    .brand:hover {
      transform: scale(1.05);
    }

    .right-panel {
      flex: 1.4;
      background: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px 100px;
      margin-top: -120px;
    }

    .right-panel h1 {
      color: #159000;
      font-size: 2.3rem;
      font-weight: 700;
      margin-bottom: 40px;
      margin-top: 80px;
      text-align: center;
    }

    form {
      width: 100%;
      max-width: 600px;
    }

    .input-group {
      position: relative;
      margin-bottom: 30px;
    }

    .input-group label {
      font-size: 16px;
      color: #000;
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
    }

    .input-group input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border: none;
      border-bottom: 2px solid #000;
      font-size: 15px;
      outline: none;
      color: #000;
    }

    .input-group input:focus {
      border-color: #159000;
    }

    .input-group i {
      position: absolute;
      left: 10px;
      color: #555;
      top: 50%;
      transform: translateY(-50%);
      font-style: normal;
    }

    #cedula-group {
      margin-top: 40px;
    }

    #new-password-group,
    #confirm-password-group {
      margin-top: 60px;
    }

    .error-text {
      color: red;
      font-size: 13px;
      margin-top: 4px;
      display: none;
    }

    button {
      background-color: #159000;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 28px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      display: block;
      margin: 80px auto 0 auto;
      transition: 0.3s;
    }

    button:hover {
      background-color: #0f6e00;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="left-panel">
      <div class="brand" id="logo-redirect">
        <div class="logo">
          <img src="../../../Assets/LOGOINGRESAR.png" alt="Logo KonCheck" />
        </div>
        <h1>KonCheck</h1>
      </div>
    </div>

    <div class="right-panel">
      <h1>Reestablecer Contrase√±a</h1>

      <form id="reset-form">
        <div class="input-group" id="cedula-group">
          <label for="cedula">N√∫mero de C√©dula (10 d√≠gitos)</label>
          <i>üÜî</i>
          <input type="text" id="cedula" placeholder="N√∫mero de identificaci√≥n (10 d√≠gitos)" maxlength="10" required />
          <small class="error-text" id="cedula-error-text">La c√©dula debe tener exactamente 10 d√≠gitos</small>
          <small class="error-text" id="cedula-db-error-text">La c√©dula no coincide con nuestros registros</small>
        </div>

        <div class="input-group" id="new-password-group">
          <label for="new-password">Nueva Contrase√±a</label>
          <i>üîí</i>
          <input type="password" id="new-password" placeholder="Contrase√±a" maxlength="10" required />
          <small class="error-text" id="password-error-text">La contrase√±a no puede tener m√°s de 10 caracteres</small>
        </div>

        <div class="input-group" id="confirm-password-group">
          <label for="confirm-password">Confirmar Contrase√±a</label>
          <i>üîí</i>
          <input type="password" id="confirm-password" placeholder="Confirmar contrase√±a" maxlength="10" required />
          <small class="error-text" id="confirm-error-text">Las contrase√±as no coinciden</small>
        </div>

        <button type="submit" id="confirm-button">Confirmar</button>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001';
    const cedulaInput = document.getElementById('cedula');
    const passwordInput = document.getElementById('new-password');
    const confirmInput = document.getElementById('confirm-password');
    const confirmButton = document.getElementById('confirm-button');

    const cedulaErrorText = document.getElementById('cedula-error-text');
    const cedulaDbErrorText = document.getElementById('cedula-db-error-text');
    const passwordErrorText = document.getElementById('password-error-text');
    const confirmErrorText = document.getElementById('confirm-error-text');

    // üß© Funci√≥n de overlay iframe
    function mostrarOverlayIframe(url) {
      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.style.position = 'fixed';
      iframe.style.top = '0';
      iframe.style.left = '0';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = 'none';
      iframe.style.zIndex = '9999';
      document.body.appendChild(iframe);
    }

    // üîπ Deshabilitar campos al inicio
    passwordInput.disabled = true;
    confirmInput.disabled = true;
    confirmButton.disabled = true;

    // üîπ Validar c√©dula en la API al ingresar los 10 d√≠gitos
    cedulaInput.addEventListener('input', async (e) => {
      const value = e.target.value.replace(/[^0-9]/g, '');
      e.target.value = value.slice(0, 10);

      cedulaErrorText.style.display = 'none';
      cedulaDbErrorText.style.display = 'none';

      if (value.length !== 10) {
        cedulaErrorText.style.display = 'block';
        passwordInput.disabled = true;
        confirmInput.disabled = true;
        confirmButton.disabled = true;
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/auth/fuerza-publica/validate/${value}`);
        const data = await response.json();

        if (data.exists) {
          passwordInput.disabled = false;
          confirmInput.disabled = false;
          confirmButton.disabled = false;
        } else {
          cedulaDbErrorText.style.display = 'block';
          passwordInput.disabled = true;
          confirmInput.disabled = true;
          confirmButton.disabled = true;
        }
      } catch (error) {
        console.error("Error consultando la API:", error);
      }
    });

    // üîπ Validar env√≠o final
    document.getElementById('reset-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const cedula = cedulaInput.value.trim();
      const pass = passwordInput.value;
      const confirm = confirmInput.value;

      passwordErrorText.style.display = 'none';
      confirmErrorText.style.display = 'none';

      if (pass.length === 0 || pass.length > 10) {
        passwordErrorText.style.display = 'block';
        return;
      }

      if (pass !== confirm) {
        confirmErrorText.style.display = 'block';
        return;
      }

      try {
        const changeResponse = await fetch(`${API_BASE}/api/auth/fuerza-publica/change-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identificacion: cedula, newPassword: pass })
        });

        const changeData = await changeResponse.json();

        if (changeData.success) {
          alert('‚úÖ ¬°Operaci√≥n exitosa!\n\nContrase√±a actualizada correctamente en la base de datos.\n\nTe llevaremos a phpMyAdmin para que veas los cambios...');
          window.location.href = 'http://localhost/phpmyadmin/index.php?route=/sql&db=koncheck_db&table=usuario_fuerza_publica&pos=0';
        } else {
          alert(`‚ùå Error: ${changeData.error}`);
        }
      } catch (error) {
        console.error("Error cambiando la contrase√±a:", error);
      }
    });
  </script>

  <!-- üîπ Script de redirecci√≥n del logo -->
  <script src="../../js/logo-redirect.js"></script>
</body>

</html>